{% extends 'base.html' %}

{% block title %}Resultado del Escaneo - GeoPet{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h2 class="mb-0"><i class="fas fa-paw me-2"></i>¡Mascota Encontrada!</h2>
                </div>
                <div class="card-body">
                    {% include 'partials/flash_messages.html' %}
                    
                    <div class="alert alert-info">
                        <p><i class="fas fa-bell me-2"></i><strong>Estado:</strong> {{ notification_status }}</p>
                    </div>
                    
                    <div class="pet-info mb-4">
                        <h3 class="mb-3 border-bottom pb-2">Información del Propietario</h3>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">Nombre:</div>
                            <div class="col-md-8">{{ nombre }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">Teléfono:</div>
                            <div class="col-md-8">{{ telefono }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">Email:</div>
                            <div class="col-md-8">{{ email }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">Mascota:</div>
                            <div class="col-md-8">{{ mascota }}</div>
                        </div>
                    </div>

                    <div class="location-section mb-4">
                        <h3 class="mb-3 border-bottom pb-2">Ubicación Registrada</h3>
                        <div class="mb-2">
                            <p>Esta es la ubicación donde el propietario registró el código QR:</p>
                        </div>
                        <div id="map" style="height: 300px; width: 100%; border-radius: 8px;"></div>
                        <div class="mt-2 text-muted">
                            <small>Coordenadas: {{ lat }}, {{ lng }}</small>
                        </div>
                    </div>
                    
                    <div class="contact-section mb-4">
                        <h3 class="mb-3 border-bottom pb-2">¿Qué hacer ahora?</h3>
                        <p>Por favor, contacta al propietario por teléfono o email para coordinar la devolución de la mascota.</p>
                        <p>El propietario ya ha sido notificado de que has escaneado este código.</p>
                    </div>
                    
                    <div class="text-center">
                        <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                            <i class="fas fa-home me-2"></i>Ir a Inicio
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Convertir coordenadas a números y verificar que sean válidas
        let latitude = parseFloat("{{ lat }}".replace(/,/g, '.'));
        let longitude = parseFloat("{{ lng }}".replace(/,/g, '.'));
        
        // Verificar si son números válidos
        if (isNaN(latitude) || isNaN(longitude)) {
            // Usar coordenadas predeterminadas si no son válidas
            latitude = 0;
            longitude = 0;
            
            // Mostrar mensaje de error
            document.getElementById('map').innerHTML = '<div class="alert alert-warning text-center">No se pudo cargar el mapa: coordenadas no válidas</div>';
            return;
        }
        
        // Inicializar el mapa con las coordenadas válidas
        const map = L.map('map').setView([latitude, longitude], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Agregar marcador en la ubicación registrada
        const markerIcon = L.icon({
            iconUrl: '{{ url_for("static", filename="img/marker-pet.png") }}',
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            popupAnchor: [0, -40]
        });
        
        const marker = L.marker([latitude, longitude], {icon: markerIcon}).addTo(map);
        marker.bindPopup("<b>Ubicación Registrada</b>").openPopup();
    });
</script>
{% endblock %} 